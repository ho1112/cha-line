# ChaLine - SBI証券配当金自動取得LINE Bot

> SBI証券の配当金情報を自動収集してLINEで通知するボット

![Project Thumbnail](public/cha-line_thumbnail.avif)

## 📋 プロジェクト概要

SBI証券のWebサイトに自動ログインして配当金履歴を収集し、LINEメッセージでリアルタイム通知を受け取ることができます。

### 核心機能
- 🔐 **自動ログイン**: ID/パスワード + メール2段階認証自動処理
- 📊 **データ収集**: 配当金履歴CSVダウンロード及びパース
- 📱 **LINE通知**: Flex Messageを活用した視覚的通知
- ⏰ **スケジューリング**: Webhookを通じた定期的自動実行

## 🛠 技術スタック

### Frontend
- **Next.js 14** (App Router)
- **TypeScript**

### Backend
- **Node.js + Express.js**
- **Playwright** (ブラウザ自動化)
- **Gmail API** (メール処理)
- **Google Apps Script** (Gmail監視 + Webhookトリガー)

### LINE Bot Integration
- **@line/bot-sdk (v10.0.0)**
- **LINE Flex Message**
- **LINE Webhook**

### Deployment
- **Google Cloud Platform (VM)**
- **PM2** (プロセス管理)

### その他ライブラリ
- **csv-parse**: CSVファイルパース
- **iconv-lite**: Shift_JISエンコーディング処理
- **googleapis**: Gmail API連動

## 🔄 システムアーキテクチャ

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Webhook       │───▶│   GCP VM        │───▶│   SBI Securities│
│   (Scheduler)   │    │   (Node.js)     │    │   Website       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   LINE Bot      │◀───│   Data Parser   │◀───│   Gmail API     │
│   (Flex Msg)    │    │   (CSV)         │    │   (2FA Code)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### ワークフロー
1. **Webhook トリガー**: スケジューラが決められた時間にAPI呼び出し
2. **自動ログイン**: PlaywrightでSBI証券ログインページアクセス
3. **2段階認証**: Gmail APIで認証コード自動取得及び入力
4. **データ収集**: 配当金ページでCSVファイルダウンロード
5. **データパース**: Shift_JISエンコーディングCSVをUTF-8に変換後パース
6. **LINE送信**: パースされたデータをFlex Message形態でLINE送信

## ✨ 主要機能

### 🔐 自動認証システム
- **複合認証処理**: ID/パスワード + メール2FA + デバイス登録
- **動的コード認識**: リアルタイムで変更される認証コード自動検知
- **再試行ロジック**: 認証失敗時自動再試行（最大3回）

### 📊 データ処理
- **CSVダウンロード**: 動的に生成されるダウンロードボタン検知
- **エンコーディング変換**: Shift_JIS → UTF-8自動変換
- **データ検証**: 配当金履歴存在有無確認

### 📱 LINEメッセージ
- **Flex Message**: 構造化された視覚的メッセージ形態
- **国別フラグ**: 各銘柄の国家表示
- **金額フォーマット**: 通貨別適切な形式で表示
- **口座区分**: 特定口座/NISA等口座タイプ表示

### ⚡ 安定性
- **ヘッドレスブラウザ**: サーバー環境で安定的実行
- **タイムアウト処理**: ネットワーク遅延対応
- **エラーハンドリング**: 各段階別失敗状況処理

## 📱 結果物

<img src="public/line_flex.avif" alt="LINE Flex Message" width="400">

実際にLINEで受信される配当金通知メッセージです。各配当金情報がきれいに整理されて表示され、国別フラグと共に銘柄名、配当金額、口座情報を一目で確認できます。

---

# ChaLine - SBI증권 배당금 자동수집 LINE Bot

> SBI증권의 배당금 정보를 자동수집하여 LINE으로 통지하는 봇

## 📋 프로젝트 개요

SBI증권 웹사이트에 자동으로 로그인하여 배당금 내역을 수집하고, 이를 LINE 메시지로 실시간 알림받을 수 있습니다.

### 핵심 기능
- 🔐 **자동 로그인**: ID/비밀번호 + 이메일 2단계 인증 자동 처리
- 📊 **데이터 수집**: 배당금 내역 CSV 다운로드 및 파싱
- 📱 **LINE 알림**: Flex Message를 활용한 시각적 알림
- ⏰ **스케줄링**: 웹훅을 통한 정기적 자동 실행

## 🛠 기술 스택

### Frontend
- **Next.js 14** (App Router)
- **TypeScript**

### Backend
- **Node.js + Express.js**
- **Playwright** (브라우저 자동화)
- **Gmail API** (이메일 처리)
- **Google Apps Script** (Gmail 감지 및 웹훅 트리거)

### LINE Bot Integration
- **@line/bot-sdk (v10.0.0)**
- **LINE Flex Message**
- **LINE Webhook**

### Deployment
- **Google Cloud Platform (VM)**
- **PM2** (프로세스 관리)

### 기타 라이브러리
- **csv-parse**: CSV 파일 파싱
- **iconv-lite**: Shift_JIS 인코딩 처리
- **googleapis**: Gmail API 연동

## 🔄 시스템 아키텍처

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Webhook       │───▶│   GCP VM        │───▶│   SBI Securities│
│   (Scheduler)   │    │   (Node.js)     │    │   Website       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   LINE Bot      │◀───│   Data Parser   │◀───│   Gmail API     │
│   (Flex Msg)    │    │   (CSV)         │    │   (2FA Code)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 워크플로우
1. **웹훅 트리거**: 스케줄러가 정해진 시간에 API 호출
2. **자동 로그인**: Playwright로 SBI증권 로그인 페이지 접근
3. **2단계 인증**: Gmail API로 인증 코드 자동 획득 및 입력
4. **데이터 수집**: 배당금 페이지에서 CSV 파일 다운로드
5. **데이터 파싱**: Shift_JIS 인코딩 CSV를 UTF-8로 변환 후 파싱
6. **LINE 전송**: 파싱된 데이터를 Flex Message 형태로 LINE 전송

## ✨ 주요 기능

### 🔐 자동 인증 시스템
- **복합 인증 처리**: ID/비밀번호 + 이메일 2FA + 디바이스 등록
- **동적 코드 인식**: 실시간으로 변경되는 인증 코드 자동 감지
- **재시도 로직**: 인증 실패 시 자동 재시도 (최대 3회)

### 📊 데이터 처리
- **CSV 다운로드**: 동적으로 생성되는 다운로드 버튼 감지
- **인코딩 변환**: Shift_JIS → UTF-8 자동 변환
- **데이터 검증**: 배당금 내역 존재 여부 확인

### 📱 LINE 메시지
- **Flex Message**: 구조화된 시각적 메시지 형태
- **국가별 플래그**: 각 종목의 국가 표시
- **금액 포맷팅**: 통화별 적절한 형식으로 표시
- **계좌 구분**: 특정계좌/NISA 등 계좌 유형 표시

### ⚡ 안정성
- **헤드리스 브라우저**: 서버 환경에서 안정적 실행
- **타임아웃 처리**: 네트워크 지연 대응
- **에러 핸들링**: 각 단계별 실패 상황 처리

## 📱 결과물

<img src="public/line_flex.avif" alt="LINE Flex Message" width="400">

실제 LINE으로 수신되는 배당금 알림 메시지입니다. 각 배당금 정보가 깔끔하게 정리되어 표시되며, 국가별 플래그와 함께 종목명, 배당금액, 계좌 정보를 한눈에 확인할 수 있습니다.

---
